<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>James Shopping üõçÔ∏è Center</title>
  <style>
    :root{
      --accent:#0ea5a4;
      --muted:#6b7280;
      --card:#fff;
      --bg:#f8fafc;
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:#0f172a}
    .container{max-width:1100px;margin:18px auto;padding:16px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:48px;height:48px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#60a5fa);display:grid;place-items:center;color:#fff;font-weight:800}
    h1{font-size:1.05rem;margin:0}
    .searchRow{display:flex;gap:8px;align-items:center;margin-top:12px}
    .searchBar{flex:1;display:flex;gap:8px}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff}
    button{background:var(--accent);color:#fff;padding:10px 12px;border-radius:8px;border:0;cursor:pointer}
    button.ghost{background:transparent;color:var(--accent);border:1px solid rgba(14,165,164,0.12)}
    .grid{display:grid;grid-template-columns:1fr 340px;gap:18px;margin-top:18px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
    .categories{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .cat{padding:8px 12px;border-radius:999px;background:#fff;cursor:pointer;border:1px solid rgba(2,6,23,0.04)}
    .cat.active{background:var(--accent);color:#fff}
    .products{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    @media (max-width:900px){.products{grid-template-columns:repeat(2,1fr)}}@media (max-width:420px){.products{grid-template-columns:1fr}}
    .product{padding:10px;border-radius:10px;display:flex;flex-direction:column;gap:8px}
    .product img{width:100%;height:160px;object-fit:cover;border-radius:8px}
    .aside .section{margin-bottom:12px}
    .cart-items{display:flex;flex-direction:column;gap:10px}
    .cart-item{display:flex;gap:10px;align-items:center}
    .smallImg{width:56px;height:56px;border-radius:8px;object-fit:cover}
    .modal{position:fixed;inset:0;background:rgba(2,6,23,0.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:60}
    .modal.open{display:flex}
    .modalContent{width:100%;max-width:820px;background:var(--card);border-radius:12px;padding:18px}
    .formRow{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    @media (max-width:680px){.formRow{grid-template-columns:1fr}}
    footer{margin-top:22px;text-align:center;color:var(--muted);font-size:0.9rem}
    .muted{color:var(--muted);font-size:0.95rem}
    .flex{display:flex;gap:8px;align-items:center}
    .pill{padding:6px 8px;border-radius:8px;background:#eef2f7}
    .toast{position:fixed;right:20px;bottom:20px;padding:10px 14px;border-radius:10px;background:var(--accent);color:#fff;box-shadow:0 6px 18px rgba(2,6,23,0.2);z-index:80}
    nav{display:flex;gap:10px;align-items:center}
    .nav-link{background:transparent;border:0;padding:6px 8px;border-radius:8px;cursor:pointer}
    .quantity{display:flex;align-items:center;gap:8px}
    table{width:100%;border-collapse:collapse}th,td{padding:8px;border-bottom:1px solid #f1f5f9;text-align:left}
    .status-pill{padding:6px 8px;border-radius:8px;font-weight:700;background:#eef2f7}
    .mutedSmall{color:var(--muted);font-size:0.85rem}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand">
        <div class="logo">JS</div>
        <div>
          <h1>James Shopping üõçÔ∏è Center</h1>
          <div class="muted">Buy & sell ‚Äî demo front-end</div>
        </div>
      </div>

      <div class="flex">
        <nav id="mainNav"></nav>
        <div id="userBadge" class="pill">Not signed in</div>
        <button id="openLogin">Login / Signup</button>
        <button id="openSell" class="ghost">Sell Item</button>
      </div>
    </header>

    <div class="searchRow">
      <div class="searchBar">
        <input id="searchInput" type="search" placeholder="Search products, categories..." />
        <select id="sortSelect" style="width:140px">
          <option value="relevance">Sort: Relevance</option>
          <option value="price_asc">Price ‚Üë</option>
          <option value="price_desc">Price ‚Üì</option>
        </select>
      </div>
      <div class="pill" id="geoStatus">Location: <span id="geoText">unknown</span></div>
    </div>

    <div class="grid">
      <main>
        <section class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <h2 style="margin:0">Categories</h2>
              <div class="muted">Tap to filter</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button onclick="document.getElementById('products').scrollIntoView({behavior:'smooth'})">üõçÔ∏è Shop Now</button>
              <div class="muted" style="font-size:0.9rem">WhatsApp: <strong>07040748910</strong></div>
            </div>
          </div>
          <div class="categories" id="categories"></div>
        </section>

        <section class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2 style="margin:0">Featured Products</h2>
            <div class="muted">Click a product to view details</div>
          </div>
          <div id="products" class="products"></div>
        </section>

        <section class="card" style="margin-top:12px;display:none" id="ordersSection">
          <h2>My Orders</h2>
          <div id="myOrdersList"></div>
        </section>

        <section class="card" style="margin-top:12px;display:none" id="supportSection">
          <h2>Contact / Support</h2>
          <div class="muted">Message owner (messages sent via Formspree)</div>
          <form id="contactForm" action="https://formspree.io/f/mvgbllaw" method="POST" style="margin-top:8px">
            <input name="name" placeholder="Your name" required />
            <input type="email" name="email" placeholder="Email" required style="margin-top:8px" />
            <input name="whatsapp" placeholder="WhatsApp number (optional)" style="margin-top:8px" />
            <textarea name="message" placeholder="Message" rows="3" style="margin-top:8px"></textarea>
            <button type="submit" style="margin-top:8px">Send</button>
            <div class="muted" style="font-size:0.8rem;margin-top:6px">Messages will be forwarded to the site owner.</div>
          </form>
        </section>
      </main>

      <aside class="aside">
        <div class="card section">
          <h3 style="margin-top:0">Shopping Cart</h3>
          <div id="cartList" class="cart-items"></div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px">
            <div class="muted">Total: $<span id="cartTotal">0.00</span></div>
            <button id="checkoutBtn">Checkout</button>
          </div>
        </div>

        <div class="card section">
          <h4 style="margin:0 0 8px 0">Support</h4>
          <div class="muted">Or WhatsApp: <strong>07040748910</strong></div>
          <div style="margin-top:8px">Contact form is in the main content area.</div>
        </div>

        <div class="card section">
          <h4 style="margin:0 0 8px 0">Admin</h4>
          <div class="muted">Open admin dashboard (admin user required)</div>
          <button id="openAdmin" class="ghost" style="margin-top:8px">Open Admin Panel</button>
        </div>
      </aside>
    </div>

    <footer>
      James Shopping üõçÔ∏è Center ‚Äî demo marketplace. Data stored locally in your browser (localStorage).
    </footer>
  </div>

  <div id="modal" class="modal"><div class="modalContent" id="modalContent"></div></div>

  <script>
    /* -------------------------
       In-memory DB persisted to localStorage
       ------------------------- */
    const DB = {
      users: JSON.parse(localStorage.getItem('js_users') || 'null') || [
        { id: 1, role: 'admin', name: 'Owner', email: 'myformspree53@gmail.com', phone: '07040748910', password: 'admin123' }
      ],
      products: JSON.parse(localStorage.getItem('js_products') || 'null') || [
        { id: 1, title: 'Wireless Headphones', desc: 'Comfortable noise-cancelling', price: 79.99, category: 'Electronics', img: 'https://images.unsplash.com/photo-1517336714731-489689fd1ca8?auto=format&fit=crop&w=800&q=60', sellerId: 1 },
        { id: 2, title: 'Casual Sneakers', desc: 'Stylish everyday sneakers', price: 49.99, category: 'Fashion', img: 'https://images.unsplash.com/photo-1600180758890-4b62d6a3b3d2?auto=format&fit=crop&w=800&q=60', sellerId: 1 },
        { id: 3, title: 'Organic Coffee Beans', desc: 'Freshly roasted 1kg', price: 15.00, category: 'Food', img: 'https://images.unsplash.com/photo-1509042239860-f550ce710b93?auto=format&fit=crop&w=800&q=60', sellerId: 1 }
      ],
      cart: JSON.parse(localStorage.getItem('js_cart') || 'null') || [],
      orders: JSON.parse(localStorage.getItem('js_orders') || 'null') || [],
      currentUser: JSON.parse(localStorage.getItem('js_user') || 'null') || null
    };

    function persist(){
      localStorage.setItem('js_users', JSON.stringify(DB.users));
      localStorage.setItem('js_products', JSON.stringify(DB.products));
      localStorage.setItem('js_cart', JSON.stringify(DB.cart));
      localStorage.setItem('js_orders', JSON.stringify(DB.orders));
      localStorage.setItem('js_user', JSON.stringify(DB.currentUser));
      renderNav();
    }

    /* -------------------------
       UI references
       ------------------------- */
    const categoriesEl = document.getElementById('categories');
    const productsEl = document.getElementById('products');
    const cartList = document.getElementById('cartList');
    const cartTotal = document.getElementById('cartTotal');
    const userBadge = document.getElementById('userBadge');
    const geoText = document.getElementById('geoText');

    /* -------------------------
       Utilities
       ------------------------- */
    function toast(msg, t = 2200){ const d = document.createElement('div'); d.className = 'toast'; d.textContent = msg; document.body.appendChild(d); setTimeout(()=>d.remove(), t); }
    function showModal(html){ const modal = document.getElementById('modal'); document.getElementById('modalContent').innerHTML = html; modal.classList.add('open'); }
    function closeModal(){ document.getElementById('modal').classList.remove('open'); }
    document.getElementById('modal').addEventListener('click', e => { if(e.target.id === 'modal') closeModal(); });

    function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    /* -------------------------
       Categories & Products
       ------------------------- */
    function uniqueCategories(){ const s = new Set(DB.products.map(p => p.category)); return ['All', ...s]; }
    let activeCategory = 'All';
    function renderCategories(){
      categoriesEl.innerHTML = '';
      uniqueCategories().forEach(c => {
        const btn = document.createElement('div');
        btn.className = 'cat' + (c === activeCategory ? ' active' : '');
        btn.textContent = c;
        btn.addEventListener('click', () => { activeCategory = c; renderCategories(); renderProducts(); });
        categoriesEl.appendChild(btn);
      });
    }

    function renderProducts(){
      const q = document.getElementById('searchInput').value.toLowerCase();
      const sort = document.getElementById('sortSelect').value;
      let list = DB.products.filter(p => activeCategory === 'All' || p.category === activeCategory);
      if(q) list = list.filter(p => (p.title + ' ' + p.desc + ' ' + p.category).toLowerCase().includes(q));
      if(sort === 'price_asc') list.sort((a,b)=>a.price-b.price);
      if(sort === 'price_desc') list.sort((a,b)=>b.price-a.price);
      productsEl.innerHTML = '';

      list.forEach(p => {
        const d = document.createElement('div'); d.className = 'product card';
        d.innerHTML = `
          <img src="${p.img}" alt="${escapeHtml(p.title)}" loading="lazy" />
          <div style="flex:1">
            <strong>${escapeHtml(p.title)}</strong>
            <div class="muted" style="font-size:0.9rem">${escapeHtml(p.category)} ‚Ä¢ $${p.price.toFixed(2)}</div>
            <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
              <div style="display:flex;gap:8px">
                <button class="ghost viewBtn">View</button>
                <button class="ghost buyNowBtn">Buy Now</button>
              </div>
              <div style="display:flex;gap:8px;align-items:center">
                <input type="number" class="qtyInput" value="1" min="1" style="width:68px;padding:6px;border-radius:8px;border:1px solid #e6e9ee" />
                <button class="addBtn">Add</button>
              </div>
            </div>
          </div>
        `;
        // attach handlers
        d.querySelector('.viewBtn').addEventListener('click', ()=> openProductModal(p.id));
        d.querySelector('.addBtn').addEventListener('click', ()=> {
          if(!requireAuth()) return;
          const qv = Number(d.querySelector('.qtyInput').value) || 1;
          addToCart(p.id, qv);
        });
        d.querySelector('.buyNowBtn').addEventListener('click', ()=> {
          if(!requireAuth()) return;
          const qv = Number(d.querySelector('.qtyInput').value) || 1;
          buyNow(p.id, qv);
        });
        productsEl.appendChild(d);
      });
    }

    function openProductModal(id){
      const p = DB.products.find(x => x.id === id);
      showModal(`
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <img src="${p.img}" style="width:40%;min-width:200px;border-radius:8px;object-fit:cover" />
          <div style="flex:1">
            <h3 style="margin-top:0">${escapeHtml(p.title)} ‚Äî $${p.price.toFixed(2)}</h3>
            <div class="muted">Category: ${escapeHtml(p.category)}</div>
            <p style="margin-top:8px">${escapeHtml(p.desc)}</p>
            <div style="display:flex;gap:8px;margin-top:12px;align-items:center;flex-wrap:wrap">
              <div class="quantity"><button class="ghost" id="dec">-</button><input id="modalQty" type="number" value="1" min="1" style="width:68px;padding:6px;border-radius:8px;border:1px solid #e6e9ee" /><button class="ghost" id="inc">+</button></div>
              <button id="modalAdd">Add to cart</button>
              <button id="modalBuy" class="ghost">Buy Now</button>
              <button class="ghost" onclick="closeModal()">Close</button>
            </div>
          </div>
        </div>
      `);

      document.getElementById('inc').addEventListener('click', ()=> {
        const el = document.getElementById('modalQty'); el.value = Number(el.value) + 1;
      });
      document.getElementById('dec').addEventListener('click', ()=> {
        const el = document.getElementById('modalQty'); el.value = Math.max(1, Number(el.value) - 1);
      });
      document.getElementById('modalAdd').addEventListener('click', ()=> {
        if(!requireAuth()) return;
        const qv = Number(document.getElementById('modalQty').value) || 1;
        addToCart(id, qv);
        closeModal();
      });
      document.getElementById('modalBuy').addEventListener('click', ()=> {
        if(!requireAuth()) return;
        const qv = Number(document.getElementById('modalQty').value) || 1;
        buyNow(id, qv);
      });
    }

    /* -------------------------
       Cart
       ------------------------- */
    function addToCart(id, qty = 1){
      const prod = DB.products.find(p => p.id === id);
      const found = DB.cart.find(i => i.id === id);
      if(found){ found.qty += qty; } else DB.cart.push({ id: prod.id, qty });
      persist(); renderCart(); toast('Added to cart');
    }

    function renderCart(){
      cartList.innerHTML = '';
      let total = 0;
      DB.cart.forEach(item => {
        const p = DB.products.find(x => x.id === item.id);
        total += p.price * item.qty;
        const el = document.createElement('div'); el.className = 'cart-item';
        el.innerHTML = `
          <img src="${p.img}" class="smallImg" />
          <div style="flex:1">
            <div><strong>${escapeHtml(p.title)}</strong></div>
            <div class="muted">$${p.price.toFixed(2)} √ó ${item.qty}</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:6px">
            <button class="ghost plus">+</button>
            <button class="ghost minus">-</button>
          </div>
        `;
        el.querySelector('.plus').addEventListener('click', ()=>{ item.qty++; persist(); renderCart(); });
        el.querySelector('.minus').addEventListener('click', ()=>{ item.qty--; if(item.qty<=0) DB.cart = DB.cart.filter(i => i.id !== item.id); persist(); renderCart(); });
        cartList.appendChild(el);
      });
      cartTotal.textContent = total.toFixed(2);
    }

    function buyNow(id, qty=1){
      DB.cart = [{ id, qty }];
      persist(); renderCart(); closeModal(); openCheckout();
    }

    /* -------------------------
       Checkout (requires auth)
       ------------------------- */
    document.getElementById('checkoutBtn').addEventListener('click', ()=> {
      if(!requireAuth()) return;
      if(DB.cart.length === 0){ toast('Cart is empty'); return; }
      openCheckout();
    });

    async function openCheckout(){
      const user = DB.currentUser;
      const preName = user ? user.name : '';
      const preEmail = user ? user.email : '';
      const prePhone = user && user.phone ? user.phone : '';
      showModal(`
        <h3>Checkout</h3>
        <form id="checkoutForm">
          <div class="formRow">
            <input name="name" placeholder="Full name" required value="${escapeHtml(preName)}" />
            <input name="email" type="email" placeholder="Email" required value="${escapeHtml(preEmail)}" />
          </div>
          <input name="phone" placeholder="Phone number" style="margin-top:8px" required value="${escapeHtml(prePhone)}" />
          <textarea name="address" placeholder="Delivery address" rows="3" style="margin-top:8px" required></textarea>
          <div style="margin-top:8px"><label><input type="checkbox" id="attachLocation" checked /> Attach current location to delivery</label></div>
          <div style="display:flex;gap:8px;margin-top:8px;"><button type="submit">Place Order</button><button type="button" class="ghost" onclick="closeModal()">Cancel</button></div>
        </form>
      `);

      document.getElementById('checkoutForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = e.target.name.value;
        const email = e.target.email.value;
        const phone = e.target.phone.value;
        const addr = e.target.address.value;
        const attach = document.getElementById('attachLocation').checked;
        let coords = null;
        if(attach && navigator.geolocation){
          try{
            coords = await new Promise((res, rej) =>
              navigator.geolocation.getCurrentPosition(p => res({lat: p.coords.latitude, lng: p.coords.longitude}), rej, { timeout: 10000 })
            );
          }catch(err){ coords = null; }
        }
        const orderId = 'ORD' + Date.now();
        const items = DB.cart.map(i => ({ id: i.id, qty: i.qty, product: DB.products.find(p => p.id === i.id) }));
        const total = items.reduce((s, it) => s + it.product.price * it.qty, 0);
        const order = { id: orderId, buyerName: name, buyerEmail: email, buyerPhone: phone, address: addr, coords, items, total, status: 'Pending', createdAt: Date.now() };
        DB.orders.unshift(order);
        DB.cart = [];
        persist(); renderCart(); renderMyOrders(); closeModal();
        showModal(`<h3>Thanks, ${escapeHtml(name)}!</h3><p class="muted">Order ${orderId} placed. Total: $${total.toFixed(2)}</p><p>Delivery to: ${escapeHtml(addr)}</p><div style="margin-top:10px"><button onclick="closeModal()">Close</button></div>`);
      });
    }

    /* -------------------------
       Orders view
       ------------------------- */
    function renderMyOrders(){
      const section = document.getElementById('ordersSection');
      const list = document.getElementById('myOrdersList');
      section.style.display = 'block';
      list.innerHTML = '';
      if(!DB.currentUser){ list.innerHTML = '<div class="muted">Sign in to view your orders.</div>'; return; }
      const orders = DB.currentUser.role === 'admin' ? DB.orders : DB.orders.filter(o => o.buyerEmail === DB.currentUser.email);
      if(orders.length === 0){ list.innerHTML = '<div class="muted">No orders found.</div>'; return; }
      orders.forEach(o => {
        const d = document.createElement('div'); d.className = 'card'; d.style.marginBottom = '10px';
        d.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><strong>Order ${o.id}</strong><div class="muted">Placed: ${new Date(o.createdAt).toLocaleString()}</div></div><div><span class="status-pill">${o.status}</span></div></div><div style="margin-top:8px">${o.items.map(it=>`<div style="display:flex;gap:8px;align-items:center;padding:6px 0"><img src='${it.product.img}' style='width:56px;height:56px;border-radius:6px;object-fit:cover' /><div><strong>${escapeHtml(it.product.title)}</strong><div class='muted'>$${it.product.price.toFixed(2)} √ó ${it.qty}</div></div></div>`).join('')}<div class="muted">Total: $${o.total.toFixed(2)}</div><div class="muted">Delivery: ${escapeHtml(o.address)}</div>${o.coords?`<div class="muted">Coords: ${o.coords.lat.toFixed(4)}, ${o.coords.lng.toFixed(4)}</div>`:''}</div>`;
        list.appendChild(d);
      });
    }

    /* -------------------------
       Auth (signup/login) & nav
       ------------------------- */
    function renderNav(){
      const nav = document.getElementById('mainNav'); nav.innerHTML = '';
      if(!DB.currentUser){
        const home = document.createElement('button'); home.className='nav-link'; home.textContent='Home'; home.addEventListener('click', ()=>{ document.getElementById('ordersSection').style.display='none'; document.getElementById('supportSection').style.display='none'; window.scrollTo({top:0,behavior:'smooth'}); });
        const contact = document.createElement('button'); contact.className='nav-link'; contact.textContent='Contact'; contact.addEventListener('click', ()=>{ document.getElementById('supportSection').style.display='block'; document.getElementById('ordersSection').style.display='none'; window.scrollTo({top:0,behavior:'smooth'});});
        nav.appendChild(home); nav.appendChild(contact);
      } else {
        const home = document.createElement('button'); home.className='nav-link'; home.textContent='Home'; home.addEventListener('click', ()=>{ document.getElementById('ordersSection').style.display='none'; document.getElementById('supportSection').style.display='none'; window.scrollTo({top:0,behavior:'smooth'}); });
        const myo = document.createElement('button'); myo.className='nav-link'; myo.textContent='My Orders'; myo.addEventListener('click', ()=>{ document.getElementById('ordersSection').style.display='block'; document.getElementById('supportSection').style.display='none'; renderMyOrders(); window.scrollTo({top:0,behavior:'smooth'}); });
        const contact = document.createElement('button'); contact.className='nav-link'; contact.textContent='Contact'; contact.addEventListener('click', ()=>{ document.getElementById('supportSection').style.display='block'; document.getElementById('ordersSection').style.display='none'; window.scrollTo({top:0,behavior:'smooth'});});
        const logout = document.createElement('button'); logout.className='nav-link'; logout.textContent='Logout'; logout.addEventListener('click', ()=>{ DB.currentUser = null; persist(); renderUser(); toast('Logged out'); });
        nav.appendChild(home); nav.appendChild(myo); nav.appendChild(contact); nav.appendChild(logout);
      }
    }

    function renderUser(){
      if(DB.currentUser){ userBadge.textContent = DB.currentUser.name + ' (' + DB.currentUser.role + ')'; }
      else userBadge.textContent = 'Not signed in';
      renderNav();
    }

    function requireAuth(){
      if(DB.currentUser) return true;
      showAuthModal('You need to sign in to continue', true);
      return false;
    }

    function showAuthModal(message = '', focusToLogin = false){
      showModal(`
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:260px">
            <h3>Login</h3>
            ${message?`<div class="mutedSmall" style="margin-bottom:8px">${escapeHtml(message)}</div>`:''}
            <form id="loginForm">
              <input name="email" placeholder="Email" required />
              <input name="password" type="password" placeholder="Password" required style="margin-top:8px" />
              <div style="display:flex;gap:8px;margin-top:8px"><button type="submit">Login</button><button type="button" class="ghost" onclick="closeModal()">Cancel</button></div>
            </form>
          </div>
          <div style="flex:1;min-width:260px">
            <h3>Signup</h3>
            <form id="signupForm">
              <input name="name" placeholder="Full name" required />
              <input name="email" placeholder="Email" required style="margin-top:8px" />
              <input name="phone" placeholder="Phone number" required style="margin-top:8px" />
              <input name="password" type="password" placeholder="Password" required style="margin-top:8px" />
              <select name="role" style="margin-top:8px"><option value="buyer">Buyer</option><option value="seller">Seller</option></select>
              <div style="display:flex;gap:8px;margin-top:8px"><button>Sign up</button><button type="button" class="ghost" onclick="closeModal()">Cancel</button></div>
            </form>
          </div>
        </div>
      `);

      // login handler
      document.getElementById('loginForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const email = e.target.email.value.trim();
        const pw = e.target.password.value;
        const user = DB.users.find(u => u.email === email && u.password === pw);
        if(user){
          DB.currentUser = { id: user.id, name: user.name, role: user.role, email: user.email, phone: user.phone };
          persist(); renderUser(); closeModal(); toast('Logged in');
        } else {
          toast('Invalid credentials');
        }
      });

      // signup handler
      document.getElementById('signupForm').addEventListener('submit', (e) => {
        e.preventDefault();
        const name = e.target.name.value.trim();
        const email = e.target.email.value.trim();
        const phone = e.target.phone.value.trim();
        const pw = e.target.password.value;
        const role = e.target.role.value;
        if(DB.users.some(u => u.email === email)){
          toast('Email already used');
          return;
        }
        const id = Date.now();
        DB.users.push({ id, name, role, email, phone, password: pw });
        DB.currentUser = { id, name, role, email, phone };
        persist(); renderUser(); closeModal(); toast('Signed up and logged in');
      });
    }

    document.getElementById('openLogin').addEventListener('click', ()=> showAuthModal());

    /* -------------------------
       Sell (seller only)
       ------------------------- */
    document.getElementById('openSell').addEventListener('click', ()=> {
      if(!DB.currentUser){ showAuthModal('Sign up as a Seller to add products', true); return; }
      if(DB.currentUser.role !== 'seller'){ toast('You must be signed in as a Seller to add products'); return; }
      showSellModal();
    });

    function showSellModal(){
      showModal(`
        <h3>Add Product</h3>
        <form id="sellForm">
          <input name="title" placeholder="Title" required />
          <input name="price" type="number" step="0.01" placeholder="Price" required style="margin-top:8px" />
          <input name="category" placeholder="Category (e.g. Electronics)" required style="margin-top:8px" />
          <textarea name="desc" placeholder="Short description" rows="3" style="margin-top:8px"></textarea>
          <input type="file" accept="image/*" name="image" style="margin-top:8px" />
          <div style="display:flex;gap:8px;margin-top:8px"><button>Add</button><button type="button" class="ghost" onclick="closeModal()">Cancel</button></div>
        </form>
      `);
      document.getElementById('sellForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const title = e.target.title.value.trim();
        const price = parseFloat(e.target.price.value);
        const category = e.target.category.value.trim();
        const desc = e.target.desc.value.trim();
        const file = e.target.image.files[0];
        let img = 'https://via.placeholder.com/400x300?text=No+Image';
        if(file) img = await readFileAsDataURL(file);
        const id = Date.now();
        DB.products.unshift({ id, title, desc, price, category, img, sellerId: DB.currentUser.id });
        persist(); renderCategories(); renderProducts(); closeModal(); toast('Product added');
      });
    }

    /* -------------------------
       Admin panel
       ------------------------- */
    document.getElementById('openAdmin').addEventListener('click', ()=> {
      if(!DB.currentUser || DB.currentUser.role !== 'admin') return toast('Admin sign-in required');
      showAdmin();
    });

    function showAdmin(){
      showModal(`
        <h3>Admin Dashboard</h3>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:320px">
            <h4>Users</h4>
            <table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th></th></tr></thead><tbody id="adminUsers"></tbody></table>
          </div>
          <div style="flex:1;min-width:320px">
            <h4>Products</h4>
            <table><thead><tr><th>Title</th><th>Price</th><th>Category</th><th></th></tr></thead><tbody id="adminProducts"></tbody></table>
          </div>
          <div style="flex:1;min-width:320px">
            <h4>Orders</h4>
            <table><thead><tr><th>Order</th><th>Buyer</th><th>Total</th><th>Status</th></tr></thead><tbody id="adminOrders"></tbody></table>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px"><button onclick="closeModal()">Close</button></div>
      `);

      const tbodyU = document.getElementById('adminUsers');
      const tbodyP = document.getElementById('adminProducts');
      const tbodyO = document.getElementById('adminOrders');

      tbodyU.innerHTML = '';
      DB.users.forEach(u => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(u.name)}</td><td>${escapeHtml(u.email)}</td><td>${escapeHtml(u.role)}</td><td><button class='ghost deleteUser'>Delete</button></td>`;
        tr.querySelector('.deleteUser').addEventListener('click', ()=>{ if(confirm('Delete user?')){ DB.users = DB.users.filter(x=>x.id!==u.id); persist(); showAdmin(); } });
        tbodyU.appendChild(tr);
      });

      tbodyP.innerHTML = '';
      DB.products.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(p.title)}</td><td>$${p.price.toFixed(2)}</td><td>${escapeHtml(p.category)}</td><td><button class='ghost deleteProd'>Delete</button></td>`;
        tr.querySelector('.deleteProd').addEventListener('click', ()=>{ if(confirm('Delete product?')){ DB.products = DB.products.filter(x=>x.id!==p.id); persist(); showAdmin(); } });
        tbodyP.appendChild(tr);
      });

      tbodyO.innerHTML = '';
      DB.orders.forEach(o => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${o.id}</td><td>${escapeHtml(o.buyerName)} (${escapeHtml(o.buyerEmail)})</td><td>$${o.total.toFixed(2)}</td><td><select class='statusSel'><option${o.status==='Pending'?' selected':''}>Pending</option><option${o.status==='Processing'?' selected':''}>Processing</option><option${o.status==='Shipped'?' selected':''}>Shipped</option><option${o.status==='Delivered'?' selected':''}>Delivered</option><option${o.status==='Cancelled'?' selected':''}>Cancelled</option></select></td>`;
        tr.querySelector('.statusSel').addEventListener('change', (e)=>{ o.status = e.target.value; persist(); toast(`Order ${o.id} set to ${o.status}`); showAdmin(); });
        tbodyO.appendChild(tr);
      });
    }

    /* -------------------------
       Geolocation for header and checkout
       ------------------------- */
    function updateGeo(){
      if(!navigator.geolocation){ geoText.textContent = 'Not supported'; return; }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const { latitude, longitude } = pos.coords;
        geoText.textContent = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
        geoText.title = `lat:${latitude}, lng:${longitude}`;
      }, (err)=>{
        if(err.code === 1) geoText.textContent = 'Denied (enable location)';
        else geoText.textContent = 'Error';
      }, { timeout: 10000 });
    }

    /* -------------------------
       Helpers
       ------------------------- */
    function readFileAsDataURL(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload = ()=> res(r.result); r.onerror = rej; r.readAsDataURL(file); }); }

    /* -------------------------
       Init & bindings
       ------------------------- */
    document.getElementById('searchInput').addEventListener('input', renderProducts);
    document.getElementById('sortSelect').addEventListener('change', renderProducts);
    document.getElementById('openLogin').addEventListener('click', ()=> showAuthModal());
    // initial render
    renderCategories(); renderProducts(); renderCart(); renderUser(); updateGeo(); renderMyOrders();

    // expose some functions for debugging / manual calls
    window.addToCart = addToCart;
    window.buyNow = buyNow;
    window.showAdmin = showAdmin;
  </script>
</body>
</html>

